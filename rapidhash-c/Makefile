CC = gcc

RAPIDHASH_TAG = rapidhash_v1.0

TEST_VECTOR_TS = \
	test_vector_fast.ts \
	test_vector_protected.ts

TARGETS = $(addprefix ../packages/rapidhash/test/,$(TEST_VECTOR_TS))

all: $(TARGETS)

.PHONY: all clean clean-target

clean:
	rm -f test_vector_{fast,protected} test_vector_{fast,protected}.ts

clean-target:
	rm -f $(TARGETS)

clean-source:
	rm -rf rapidhash

clean-all: clean clean-target clean-source

rapidhash/rapidhash.h:
	git clone --depth 1 \
		--branch $(RAPIDHASH_TAG) \
		https://github.com/Nicoshev/rapidhash.git

test_vector_fast: generate_test_vector.c rapidhash/rapidhash.h
	$(CC) generate_test_vector.c -o $@

test_vector_protected: generate_test_vector.c rapidhash/rapidhash.h
	$(CC) generate_test_vector.c -o $@ -DRAPIDHASH_PROTECTED

test_vector_%.ts: test_vector_%
	echo '/* eslint-disable */' >>$@
	echo '// This file is generated by rapidhash-c/Makefile' >>$@
	git -C rapidhash show --format='// rapidhash revision: %H' --no-patch >>$@
	./$< >>$@

$(TARGETS): $(TEST_VECTOR_TS)
	cp $^ $(dir $@)
